<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

   <title>taotao's zone</title>
   <link href="http://litaotao.github.io/atom.xml" rel="self" type="application/atom+xml"/>
   <link href="http://litaotao.github.io" rel="alternate" type="text/html" />
   <updated>2014-10-21T22:20:40+08:00</updated>
   <id>http://litaotao.github.io</id>
   <author>
     <name></name>
     <email></email>
   </author>

   
   <entry>
     <title>深度分析Erlang Application行为</title>
     <link href="/deep-into-erlang-application"/>
     <updated>2014-10-21T00:00:00+08:00</updated>
     <id>/deep-into-erlang-application</id>
     <content type="html">&lt;h2&gt;从我在Erlang and OTP in Action中第六章中的错误说起&lt;/h2&gt;

&lt;h2&gt;看看application行为在启动一个otp应用的简单流程&lt;/h2&gt;

&lt;h2&gt;load应用的过程分析&lt;/h2&gt;

&lt;h2&gt;start应用的过程分析&lt;/h2&gt;

&lt;p&gt;理论上来讲，这是个很简单的事情，甚至可以说不能再简单了。&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;在VirtualBox里面建一个OpenSolaris 64bit的虚拟机，配置足够大的内存和硬盘&lt;/li&gt;
&lt;li&gt;把&lt;a href=&quot;https://us-east.manta.joyent.com/Joyent_Dev/public/SmartOS/smartos-latest.iso&quot;&gt;SmartOS live ISO&lt;/a&gt;挂载在光驱上&lt;/li&gt;
&lt;li&gt;启动，回答屏幕上几个问题，搞定&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;没错，SmartOS就是这么简单。甚至可以用个&lt;a href=&quot;http://www.perkin.org.uk/posts/automated-virtualbox-smartos-installs.html&quot;&gt;简单的脚本&lt;/a&gt;自动化完成。&lt;/p&gt;

&lt;h2&gt;创建SmartOS zone&lt;/h2&gt;

&lt;p&gt;SmartOS里面的zone就是OS container，轻量级，隔离性好，所以一般搞搞都先弄一个，简单的应该是这么搞搞就行了&lt;/p&gt;

&lt;p&gt;先导入镜像&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;imgadm import fdea06b0-3f24-11e2-ac50-0b645575ce9d
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;然后创建一个json描述文件&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;cd /opt
vi myvm.json
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&quot;json&quot;&gt;{
 &quot;brand&quot;: &quot;joyent&quot;,
 &quot;image_uuid&quot;: &quot;fdea06b0-3f24-11e2-ac50-0b645575ce9d&quot;,
 &quot;alias&quot;: &quot;web01&quot;,
 &quot;hostname&quot;: &quot;web01&quot;,
 &quot;max_physical_memory&quot;: 512,
 &quot;quota&quot;: 20,
 &quot;nics&quot;: [
  {
    &quot;nic_tag&quot;: &quot;admin&quot;,
    &quot;ip&quot;: &quot;10.88.88.52&quot;,
    &quot;netmask&quot;: &quot;255.255.255.0&quot;,
    &quot;gateway&quot;: &quot;10.88.88.2&quot;
  }
 ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;最后&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;vmadm create -f myvm.json
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;完事了&lt;code&gt;zlogin&lt;/code&gt;到你的机器就行了。&lt;/p&gt;

&lt;p&gt;好了我就不班门弄斧了，我都是从&lt;a href=&quot;http://wiki.smartos.org/display/DOC/How+to+create+a+zone+%28+OS+virtualized+machine+%29+in+SmartOS&quot;&gt;这里&lt;/a&gt;抄的。&lt;/p&gt;

&lt;h2&gt;老湿，我的zone上不了外网啊！&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;更新：这件事情在最新版的SmartOS中应该已经修复了，见&lt;a href=&quot;http://www.listbox.com/member/archive/184463/2014/05/sort/time_rev/page/1/entry/14:199/20140525031110:BCCD6764-E3DB-11E3-AC74-888FDBEDD5D3/&quot;&gt;这里&lt;/a&gt;。&lt;/strong&gt;&lt;/p&gt;

&lt;p&gt;&lt;em&gt;以下内容应该已经过时，但是还是留下做个参考吧&lt;/em&gt;&lt;/p&gt;

&lt;blockquote&gt;&lt;p&gt;VirtualBox我设置成NAT了？啥啥我也设对了？问题解决不了，joyent的源码我都快看完了，我的zone还是上不了外网啊？？？？？？&lt;/p&gt;&lt;/blockquote&gt;

&lt;p&gt;我也上不了 :)&lt;/p&gt;

&lt;p&gt;在joyent的SmartOS wiki看到这么点&lt;a href=&quot;http://wiki.smartos.org/display/DOC/How+to+create+a+Virtual+Machine+in+SmartOS&quot;&gt;信息&lt;/a&gt;(页内搜索Zone Networking Issues)。老实说，给出了方向，连接都失效了，细节全留给你自己想了。一句话，领导风范。&lt;/p&gt;

&lt;p&gt;具体的这事情是这样：&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;&lt;p&gt;默认SmartOS ISO只针对vmware做了优化，所以默认建了个vmware的bridge，还把默认网卡绑上了。
用&lt;code&gt;dladm show-link&lt;/code&gt;看看，有个&lt;code&gt;vmwarebr&lt;/code&gt;吧。&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;按照joyent指出的方向，问题就在要建一个叫做&lt;code&gt;vboxbr&lt;/code&gt;而不是&lt;code&gt;vmwarebr&lt;/code&gt;。看来是硬编码问题，典型的扯淡问题。&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;


&lt;p&gt;那么来做&lt;/p&gt;

&lt;p&gt;先删了那个vmwarebr&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;dladm remove-bridge -l e1000g0 vmwarebr
dladm delete-bridege vmwarebr
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;再建一个&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;dladm create-bridge -l e1000g0 vboxbr
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;理论上讲这样就行了。不用重启zone，就行了。joyent是这么保证的，但是实际上有点问题，可能要把某zone删了重来（或者重新配置网络）。注意zone的网卡的mask和gateway要和e1000g0的一致。&lt;/p&gt;

&lt;p&gt;举个栗子吧&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;[root@08-00-27-1e-28-f6 ~]# netstat -rn

Routing Table: IPv4
  Destination           Gateway           Flags  Ref     Use     Interface
-------------------- -------------------- ----- ----- ---------- ---------
default              10.0.2.2             UG        4     122171 e1000g0
10.0.2.0             10.0.2.15            U         3          0 e1000g0
127.0.0.1            127.0.0.1            UH        2         84 lo0
192.168.56.0         192.168.56.13        U         4     223275 e1000g1
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;可见主网卡&lt;code&gt;e1000g0&lt;/code&gt;的gateway是&lt;code&gt;10.0.2.2&lt;/code&gt;，网段是&lt;code&gt;10.0.2.x&lt;/code&gt;。那么zone的nic就应该如下配置&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;json&quot;&gt;{
  &quot;nics&quot;: [
    {
      &quot;nic_tag&quot;: &quot;admin&quot;,
      &quot;ip&quot;: &quot;10.0.2.52&quot;,
      &quot;netmask&quot;: &quot;255.255.255.0&quot;,
      &quot;gateway&quot;: &quot;10.0.2.2&quot;
    }
  ]
}
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;其中&lt;code&gt;ip&lt;/code&gt;那里我随便选了个&lt;code&gt;10.0.2.52&lt;/code&gt;，反正不和别的机器冲突就行。&lt;/p&gt;
</content>
   </entry>
   

</feed>
