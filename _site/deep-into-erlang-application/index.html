<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>深度分析Erlang Application行为 | taotao's zone</title>
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="/css/font-awesome/css/font-awesome.min.css" type="text/css" />
  <!--<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Lato:300" type="text/css" />-->
  <!--<link rel='stylesheet' href='http://fonts.googleapis.com/css?family=Inconsolata' type='text/css' />-->
  <link rel="stylesheet" href="/css/default.css" type="text/css" />
  <link rel="stylesheet" href="/css/desktop.css" type="text/css" />
  <link rel="stylesheet" href="/css/mobile.css" type="text/css" />
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="alternate" type="application/atom+xml" title="Recent Entries" href="/atom.xml" />
  <script src="/js/jquery-1.11.0.min.js" type="text/javascript"></script>
  <script src="/js/jquery-migrate-1.2.1.js" type="text/javascript"></script>
  <script src="/js/jquery.transit.min.js" type="text/javascript"></script>
  <script src="/js/common.js" type="text/javascript"></script>
</head>
<body>
  <link rel="stylesheet" href="/js/prettify/prettify.css" />
<style type="text/css">
  html {
    /*background: url() no-repeat center center fixed;*/
    background: #333333;
    -webkit-background-size: cover;
    -moz-background-size: cover;
    -o-background-size: cover;
    background-size: cover;
  }
  body { background:transparent; }
  @media screen and (max-width: 750px){
    body { background: rgba(255, 255, 255, 0.9); }
  }
</style>

<div id="content" class="post" style="margin-top: 20px;">
  <div id="avatar" class="avatar circle" data-in-right="false" style="width: 150px; height: 150px; position: fixed; top: 40px; z-index: 99; opacity: 0;">
    <div class="center" style="margin-top: 4px; height: 142px; width: 142px; border-radius: 71px; background-image: url('../images/2.jpg');"></div>
  </div>

  <div class="entry" style="position: relative;">
    <h1 class="entry-title"><a href="/deep-into-erlang-application" title="深度分析Erlang Application行为">深度分析Erlang Application行为</a></h1>

    <p class="entry-date">2014-10-21 <span class="lastModified" style="display: none;" data-source="_posts/erlang/2014-10-21-deep-into-erlang-application.md">最后更新时间: </span></p>

    <h2>从我在Erlang and OTP in Action中第六章中的错误说起</h2>

<h2>看看application行为在启动一个otp应用的简单流程</h2>

<h2>load应用的过程分析</h2>

<h2>start应用的过程分析</h2>

<p>理论上来讲，这是个很简单的事情，甚至可以说不能再简单了。</p>

<ol>
<li>在VirtualBox里面建一个OpenSolaris 64bit的虚拟机，配置足够大的内存和硬盘</li>
<li>把<a href="https://us-east.manta.joyent.com/Joyent_Dev/public/SmartOS/smartos-latest.iso">SmartOS live ISO</a>挂载在光驱上</li>
<li>启动，回答屏幕上几个问题，搞定</li>
</ol>


<p>没错，SmartOS就是这么简单。甚至可以用个<a href="http://www.perkin.org.uk/posts/automated-virtualbox-smartos-installs.html">简单的脚本</a>自动化完成。</p>

<h2>创建SmartOS zone</h2>

<p>SmartOS里面的zone就是OS container，轻量级，隔离性好，所以一般搞搞都先弄一个，简单的应该是这么搞搞就行了</p>

<p>先导入镜像</p>

<pre><code>imgadm import fdea06b0-3f24-11e2-ac50-0b645575ce9d
</code></pre>

<p>然后创建一个json描述文件</p>

<pre><code>cd /opt
vi myvm.json
</code></pre>

<pre><code class="json">{
 "brand": "joyent",
 "image_uuid": "fdea06b0-3f24-11e2-ac50-0b645575ce9d",
 "alias": "web01",
 "hostname": "web01",
 "max_physical_memory": 512,
 "quota": 20,
 "nics": [
  {
    "nic_tag": "admin",
    "ip": "10.88.88.52",
    "netmask": "255.255.255.0",
    "gateway": "10.88.88.2"
  }
 ]
}
</code></pre>

<p>最后</p>

<pre><code>vmadm create -f myvm.json
</code></pre>

<p>完事了<code>zlogin</code>到你的机器就行了。</p>

<p>好了我就不班门弄斧了，我都是从<a href="http://wiki.smartos.org/display/DOC/How+to+create+a+zone+%28+OS+virtualized+machine+%29+in+SmartOS">这里</a>抄的。</p>

<h2>老湿，我的zone上不了外网啊！</h2>

<p><strong>更新：这件事情在最新版的SmartOS中应该已经修复了，见<a href="http://www.listbox.com/member/archive/184463/2014/05/sort/time_rev/page/1/entry/14:199/20140525031110:BCCD6764-E3DB-11E3-AC74-888FDBEDD5D3/">这里</a>。</strong></p>

<p><em>以下内容应该已经过时，但是还是留下做个参考吧</em></p>

<blockquote><p>VirtualBox我设置成NAT了？啥啥我也设对了？问题解决不了，joyent的源码我都快看完了，我的zone还是上不了外网啊？？？？？？</p></blockquote>

<p>我也上不了 :)</p>

<p>在joyent的SmartOS wiki看到这么点<a href="http://wiki.smartos.org/display/DOC/How+to+create+a+Virtual+Machine+in+SmartOS">信息</a>(页内搜索Zone Networking Issues)。老实说，给出了方向，连接都失效了，细节全留给你自己想了。一句话，领导风范。</p>

<p>具体的这事情是这样：</p>

<ol>
<li><p>默认SmartOS ISO只针对vmware做了优化，所以默认建了个vmware的bridge，还把默认网卡绑上了。
用<code>dladm show-link</code>看看，有个<code>vmwarebr</code>吧。</p></li>
<li><p>按照joyent指出的方向，问题就在要建一个叫做<code>vboxbr</code>而不是<code>vmwarebr</code>。看来是硬编码问题，典型的扯淡问题。</p></li>
</ol>


<p>那么来做</p>

<p>先删了那个vmwarebr</p>

<pre><code>dladm remove-bridge -l e1000g0 vmwarebr
dladm delete-bridege vmwarebr
</code></pre>

<p>再建一个</p>

<pre><code>dladm create-bridge -l e1000g0 vboxbr
</code></pre>

<p>理论上讲这样就行了。不用重启zone，就行了。joyent是这么保证的，但是实际上有点问题，可能要把某zone删了重来（或者重新配置网络）。注意zone的网卡的mask和gateway要和e1000g0的一致。</p>

<p>举个栗子吧</p>

<pre><code>[root@08-00-27-1e-28-f6 ~]# netstat -rn

Routing Table: IPv4
  Destination           Gateway           Flags  Ref     Use     Interface
-------------------- -------------------- ----- ----- ---------- ---------
default              10.0.2.2             UG        4     122171 e1000g0
10.0.2.0             10.0.2.15            U         3          0 e1000g0
127.0.0.1            127.0.0.1            UH        2         84 lo0
192.168.56.0         192.168.56.13        U         4     223275 e1000g1
</code></pre>

<p>可见主网卡<code>e1000g0</code>的gateway是<code>10.0.2.2</code>，网段是<code>10.0.2.x</code>。那么zone的nic就应该如下配置</p>

<pre><code class="json">{
  "nics": [
    {
      "nic_tag": "admin",
      "ip": "10.0.2.52",
      "netmask": "255.255.255.0",
      "gateway": "10.0.2.2"
    }
  ]
}
</code></pre>

<p>其中<code>ip</code>那里我随便选了个<code>10.0.2.52</code>，反正不和别的机器冲突就行。</p>


    <div id="disqus_container">
      <div style="margin-bottom:20px">
      <!-- 多说评论框 start -->
        <div class="ds-thread" data-thread-key=/deep-into-erlang-application data-title=深度分析Erlang Application行为 data-url=/deep-into-erlang-application></div>
      <!-- 多说评论框 end -->
      <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
      <script type="text/javascript">
      var duoshuoQuery = {short_name:"litaotao"};
        (function() {
          var ds = document.createElement('script');
          ds.type = 'text/javascript';ds.async = true;
          ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
          ds.charset = 'UTF-8';
          (document.getElementsByTagName('head')[0] 
           || document.getElementsByTagName('body')[0]).appendChild(ds);
        })();
        </script>
      <!-- 多说公共JS代码 end -->
      </div>
    </div>
  </div>

  <div id="menuIndex" class="sidenav">
    <div class="myinfo"><center>
      <div id="avatarHolder" class="avatar circle" style="width: 0px; height: 0px; box-shadow: none; margin-bottom: 20px;"></div>
      <a href="/index.html" title="Homepage"><i class="icon-home icon-large"></i> Home</a>
      <a href="http://www.linkedin.com/in/taotaoli"><i class="icon-linkedin-sign icon-large"></i><span> Profile</span></a>
      <a href="https://github.com/litaotao"><i class="icon-github icon-large"></i><span> Code</span></a>
      <a href="https://github.com/litaotao"><i class="icon-envelope-alt icon-large"></i><span> Mail</span></a>
    </center></div>
    <div id="menu"></div>
  </div>
</div>

<script src="/js/post.js" type="text/javascript"></script>

</body>
</html>
