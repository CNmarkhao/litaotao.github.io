---
category: web
published: false
layout: post
title: 一种单向用户关系的设计
description: 总结我自己是如何处理一种单向用户关系的设计和实现的
---  

## 
## 1. 需求和场景
　　任何设计一开始都不要太高大上了，只要在保证能用、够用的前提下，做到足够简单就行了。这里的场景是用户数短期内不会上万，用户之间只有单向关注的关系，需求是借住用户之间的这些关系，给某用户推荐相关的人物，说白了，就是：

- 二度关系：A关注了B，B关注了C，给A推荐C；
- User-based 推荐：A关注了B，C也关注了B，给A推荐C，给C推荐A；

其他需求是：

- 能少读、写数据库就尽量少，毕竟还会有其他请求要读、写数据库；
- 请求的类型有：
    + [a] 获取A关注的人物列表；
    + [b] 获取关注A的任务列表；
    + [c] 给A进行推荐；
    + [d] 针对某个用户A，更新一条关系信息，包括add、delete；
- 上面三个请求，能多快，就多快，根据伟大的2/8原则，最优先的、实时性最高的是请求a、b、d，然后才是c。

　　ok，其实分析到现在，已经可以发现这个问题并不难了，特别是用户量在短期内不会增长很多。

## 2. 初步设计  
　　首先说说我处理这个问题【其实也是处理大多数问题】的技术栈，后台用Python、Flask和Restful作为语言和web框架，用MongoDB和Redis来作为数据库和缓存，用Celery来管理移步任务。
　　刚遇到这个问题，我一开始也是想到了特征向量的方法，就像[这里](http://www.zhihu.com/question/21477117)所说的一样，用特征向量来存储每个人的用户关系，这样能简单的计算二度关系，而且对用户的关系管理[add/delete]足够简单快捷。然后，用这个方法有两个我目前觉得不够完美的问题：

- [a] 如何存储这个特征向量
- [b] 按照2/8原则来分析，这个特征向量很稀疏，会不会不必要的浪费一些空间

　　针对这两个问题，我们来仔细分析一下。

### 2.1 特征向量的存储问题
　　思考过后，我认为有两个方式：

- 把特征向量序列化后以dict格式存储在mongo中，这样最为直接，但明显不好。首先是因为如此的话每次更新都要写两次数据库，麻烦；更大的原因是每次做计算的时候，都需要先整个把数据load到内存中，然后反序列化成特征向量后计算。
- 同样是把特征向量序列化后以list格式存储在mongo中，只是这个时候换一种序列化方式，以特征向量的每一行作为一个单元序列化，但即使这样，还是会有上面提到的两个问题。

　　坦白地讲，这两个方式都有不少问题，特别是在稀疏矩阵的时候，无谓地浪费了太多空间，下面我们简单的看看到底在空间上浪费是否明显。

### 2.2 稀疏矩阵情况下空间的消耗
　　ok，现在我们假设总共有N个用户，那么每个用户的特征矩阵应该是N*N大，最简单的用True和False布尔型变量来存储关系的话，关系公式如下图。

![relation.jpg](../images/relation.jpg)

　　那么一个用户的特征变量占用的内存空间应该就是：size(bool) * N^2。这里有一个主要的点，在Python里面，bool型变量并不是简单的一个字节，每个bool型变量都是一个bool类的实例，因为这个实例里还有其他方法和元素，因此比常见的C、C++里的bool变量占用的空间大。如下图可以说吗这个情况，不过这里就先按照每个bool型变量占用1字节来计算了，这样的话特征矩阵的大小就是： f(n) = N^2/10^6 (MB)。

![bool_size_in_python.jpg](../images/bool_size_in_python.jpg)

　　简单的画个图就知道这个概念了，这个占用的空间还是不小的吧，可以看到，如果一共有用户1000个的话，每个用户的特征矩阵就1MB，用户5000个的话，就是25MB，用户10000个的话，就是100MB了，成平方增长的；而且还要注意，这里的仅仅是单个用户的特征矩阵，所有用户的特征矩阵的总空间的话，就是3次方的关系了。即，如果网站的用户有1000个的话，所有用户的特征矩阵占内存1000*1MB，如果有10000个用户的话，所有用户的特征矩阵就得占用内存10000*100=1000000MB=1000GB=1TB了，这是不是有点过火了。

![relation-matrix-size.jpg](../images/relation-matrix-size.jpg)

　　这里还有很重要的一个点，一个人的关系矩阵既然要占用这么大的空间，我不禁要问，这么大的空间里面，真正有用的数据到底占多少。这里当然依人而定了，但是2/8原则也会告诉我们，这其中80%的数据肯定是无效的，80%的空间肯定是浪费掉了的，而且所有用户中，80%的用户的数据中有80%的数据会是无效的，这些空间肯定也是无谓牺牲了的。

## 3.再次设计
　　


## n. 相关资料
- [如何设计数据结构和算法，计算并存储六度好友关系](http://www.zhihu.com/question/21477117)